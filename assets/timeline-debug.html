<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e1e1e;
      color: #dcddde;
      height: 100vh;
      padding: 20px;
      overflow: auto;
    }
    h2 { color: #7f6df2; margin-bottom: 16px; }
    .log {
      background: #2d2d2d;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success { border-left: 3px solid #4caf50; }
    .info { border-left: 3px solid #2196f3; }
    .data { border-left: 3px solid #ff9800; max-height: 200px; overflow: auto; }
  </style>
</head>
<body>
  <h2>Timeline Debug View</h2>
  <div id="logs"></div>

  <script>
    function log(msg, type = 'info', data = null) {
      const logs = document.getElementById('logs');
      const div = document.createElement('div');
      div.className = 'log ' + type;
      div.textContent = new Date().toISOString().substr(11, 12) + ' - ' + msg;
      if (data) {
        div.textContent += '\n' + JSON.stringify(data, null, 2);
      }
      logs.appendChild(div);
      logs.scrollTop = logs.scrollHeight;
    }

    log('Debug view loaded', 'success');
    log('Window location: ' + window.location.href);
    log('Parent origin check...');

    let messageCount = 0;

    window.addEventListener('message', (event) => {
      messageCount++;
      log('Message #' + messageCount + ' received', 'success');
      log('Type: ' + (event.data?.type || 'unknown'));

      if (event.data?.type === 'markwhenState') {
        const parsed = event.data?.params?.parsed;
        if (parsed?.events?.children) {
          log('Events received: ' + parsed.events.children.length + ' items', 'data');
          // Show first few events
          const sample = parsed.events.children.slice(0, 3).map(e =>
            e.firstLine?.restTrimmed || e.title || 'Group'
          );
          log('Sample: ' + sample.join(', '), 'data');
        } else {
          log('markwhenState data:', 'data', event.data?.params);
        }
      } else if (event.data?.type === 'appState') {
        log('appState received', 'data', event.data?.params);
      } else {
        log('Full message:', 'data', event.data);
      }
    });

    log('Message listener attached', 'success');

    // Signal ready
    setTimeout(() => {
      if (messageCount === 0) {
        log('No messages received after 2 seconds', 'info');
      }
    }, 2000);
  </script>
</body>
</html>
